import { useState, useRef } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { Upload, FileCode, AlertTriangle, CheckCircle, Zap, ChevronRight, X } from 'lucide-react';
import { NeonButton } from '../NeonButton';
import { useLanguage } from '../../contexts/LanguageContext';

interface Vulnerability {
  id: string;
  name: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  location: string;
  line: number;
  description?: string;
  recommendation?: string;
  codeSnippet?: string;
}

interface FileResult {
  fileName: string;
  fileSize: number;
  vulnerabilities: number;
  riskLevel: string;
}

interface AnalysisLog {
  message: string;
  type: 'info' | 'success' | 'warning';
  timestamp: string;
}

interface ScanResult {
  vulnerabilities: Vulnerability[];
  totalVulnerabilities: number;
  riskLevel: string;
  status: string;
  type?: 'file' | 'folder';
  fileName?: string;
  fileSize?: number;
  filesScanned?: number;
  totalSize?: number;
  scanTime?: string;
  fileResults?: FileResult[];
  analysisLogs?: AnalysisLog[];
}

// æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹© API åœ°å€
const API_BASE_URL = import.meta.env.PROD 
  ? '/api'  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆVercelï¼‰
  : 'http://localhost:5001/api';  // å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°åç«¯

export function VulnerabilityAnalysis() {
  const [isScanning, setIsScanning] = useState(false);
  const [scanComplete, setScanComplete] = useState(false);
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [scanResult, setScanResult] = useState<ScanResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [uploadMode, setUploadMode] = useState<'file' | 'folder'>('folder');
  const [analysisLogs, setAnalysisLogs] = useState<AnalysisLog[]>([]);
  const [showLogs, setShowLogs] = useState(true);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const folderInputRef = useRef<HTMLInputElement>(null);
  const logsEndRef = useRef<HTMLDivElement>(null);
  const { t, language } = useLanguage();

  // è‡ªåŠ¨æ»šåŠ¨åˆ°æ—¥å¿—åº•éƒ¨
  const scrollToBottom = () => {
    logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    await uploadAndScan(file);
  };

  const handleFolderSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files || files.length === 0) return;

    // æ’é™¤çš„æ–‡ä»¶å¤¹è·¯å¾„
    const excludedPaths = ['node_modules', 'build', 'dist', '.git', '.next', 'coverage', '__pycache__', 'venv', 'vendor'];
    
    // è¿‡æ»¤å‡ºä»£ç æ–‡ä»¶ï¼Œæ’é™¤å¸¸è§çš„ä¾èµ–/æ„å»ºæ–‡ä»¶å¤¹
    const codeFiles = Array.from(files).filter(file => {
      const ext = file.name.split('.').pop()?.toLowerCase();
      const filePath = (file as any).webkitRelativePath || file.name;
      
      // æ£€æŸ¥æ˜¯å¦åœ¨æ’é™¤çš„è·¯å¾„ä¸­
      const isExcluded = excludedPaths.some(excluded => 
        filePath.includes(`/${excluded}/`) || filePath.startsWith(`${excluded}/`)
      );
      
      // åªåŒ…å«æ”¯æŒçš„ä»£ç æ–‡ä»¶ä¸”ä¸åœ¨æ’é™¤è·¯å¾„ä¸­
      return !isExcluded && ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'php', 'cpp', 'c', 'go', 'rb'].includes(ext || '');
    });

    if (codeFiles.length === 0) {
      setError(language === 'zh' ? 'æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„ä»£ç æ–‡ä»¶' : 'No supported code files found in folder');
      return;
    }

    // æç¤ºæ–‡ä»¶æ•°é‡ï¼ˆä¸é™åˆ¶ï¼‰
    console.log(`å‡†å¤‡æ‰«æ ${codeFiles.length} ä¸ªä»£ç æ–‡ä»¶`);

    await uploadFolderAndScan(codeFiles);
  };

  const handleUpload = () => {
    if (uploadMode === 'folder') {
      folderInputRef.current?.click();
    } else {
      fileInputRef.current?.click();
    }
  };

  const uploadAndScan = async (file: File) => {
    setIsScanning(true);
    setScanComplete(false);
    setError(null);
    setUploadProgress(0);
    setAnalysisLogs([]);
    setShowLogs(true);

    const formData = new FormData();
    formData.append('file', file);

    try {
      // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
      const progressInterval = setInterval(() => {
        setUploadProgress(prev => {
          if (prev >= 90) {
            clearInterval(progressInterval);
            return 90;
          }
          return prev + 10;
        });
      }, 200);

      const response = await fetch(`${API_BASE_URL}/scan/upload`, {
        method: 'POST',
        body: formData,
      });

      clearInterval(progressInterval);
      setUploadProgress(100);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || errorData.message || 'æ‰«æå¤±è´¥');
      }

      const result: ScanResult = await response.json();
      
      // è®¾ç½®åˆ†ææ—¥å¿—
      if (result.analysisLogs) {
        setAnalysisLogs(result.analysisLogs);
        setTimeout(scrollToBottom, 100);
      }
      
      setScanResult(result);
      setScanComplete(true);
      
      if (result.vulnerabilities.length > 0) {
        setSelectedVuln(result.vulnerabilities[0]);
      }

    } catch (err) {
      console.error('ä¸Šä¼ é”™è¯¯:', err);
      setError(err instanceof Error ? err.message : 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
      setScanComplete(false);
    } finally {
      setIsScanning(false);
      setTimeout(() => setUploadProgress(0), 1000);
    }
  };

  const uploadFolderAndScan = async (files: File[]) => {
    setIsScanning(true);
    setScanComplete(false);
    setError(null);
    setUploadProgress(0);
    setAnalysisLogs([]);
    setShowLogs(true);

    const formData = new FormData();
    files.forEach(file => {
      formData.append('files', file);
    });

    try {
      // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
      const progressInterval = setInterval(() => {
        setUploadProgress(prev => {
          if (prev >= 90) {
            clearInterval(progressInterval);
            return 90;
          }
          return prev + 5;
        });
      }, 300);

      const response = await fetch(`${API_BASE_URL}/scan/upload-folder`, {
        method: 'POST',
        body: formData,
      });

      clearInterval(progressInterval);
      setUploadProgress(100);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || errorData.message || 'æ‰«æå¤±è´¥');
      }

      const result: ScanResult = await response.json();
      
      // è®¾ç½®åˆ†ææ—¥å¿—
      if (result.analysisLogs) {
        setAnalysisLogs(result.analysisLogs);
        setTimeout(scrollToBottom, 100);
      }
      
      setScanResult(result);
      setScanComplete(true);
      
      if (result.vulnerabilities.length > 0) {
        setSelectedVuln(result.vulnerabilities[0]);
      }

    } catch (err) {
      console.error('ä¸Šä¼ é”™è¯¯:', err);
      setError(err instanceof Error ? err.message : 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
      setScanComplete(false);
    } finally {
      setIsScanning(false);
      setTimeout(() => setUploadProgress(0), 1000);
    }
  };

  const handleDrop = async (event: React.DragEvent<HTMLDivElement>) => {
    event.preventDefault();
    
    const items = event.dataTransfer.items;
    const files: File[] = [];

    // å¤„ç†æ‹–æ‹½çš„æ–‡ä»¶
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.kind === 'file') {
        const file = item.getAsFile();
        if (file) {
          const ext = file.name.split('.').pop()?.toLowerCase();
          if (['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'php', 'cpp', 'c', 'go', 'rb'].includes(ext || '')) {
            files.push(file);
          }
        }
      }
    }

    if (files.length === 0) {
      setError(language === 'zh' ? 'æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„ä»£ç æ–‡ä»¶' : 'No supported code files found');
      return;
    }

    if (files.length === 1) {
      await uploadAndScan(files[0]);
    } else {
      await uploadFolderAndScan(files);
    }
  };

  const handleDragOver = (event: React.DragEvent<HTMLDivElement>) => {
    event.preventDefault();
  };

  const resetScan = () => {
    setScanComplete(false);
    setScanResult(null);
    setSelectedVuln(null);
    setError(null);
    setAnalysisLogs([]);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
    if (folderInputRef.current) {
      folderInputRef.current.value = '';
    }
  };

  const severityColors = {
    critical: 'border-[#FF0055] text-[#FF0055]',
    high: 'border-[#FF3333] text-[#FF3333]',
    medium: 'border-[#FF9933] text-[#FF9933]',
    low: 'border-[#FFCC33] text-[#FFCC33]',
  };

  const vulnerabilities = scanResult?.vulnerabilities || [];

  return (
    <div className="min-h-screen bg-[#0A0A0A] py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        {/* Hero Section */}
        <motion.div
          className="text-center mb-12"
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <h1 className="font-mono text-4xl mb-4 text-[#00FF88] tracking-wider">
            {t('vuln.hero.title')}
          </h1>
          <p className="font-mono text-lg text-[#00FF88]/60">
            {t('vuln.hero.desc')}
          </p>
        </motion.div>

        {/* Upload Section */}
        {!scanComplete && (
          <motion.div
            className="bg-[#0A0A0A] border border-[#00FF88] p-12 mb-8 relative overflow-hidden cursor-pointer hover:border-[#33FFB8] transition-colors"
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onClick={() => !isScanning && handleUpload()}
          >
            {/* Hidden File Input */}
            <input
              ref={fileInputRef}
              type="file"
              accept=".js,.jsx,.ts,.tsx,.py,.java,.php,.cpp,.c,.go,.rb"
              onChange={handleFileSelect}
              className="hidden"
            />
            {/* Hidden Folder Input */}
            <input
              ref={folderInputRef}
              type="file"
              // @ts-ignore - webkitdirectory is not in TypeScript types
              webkitdirectory=""
              directory=""
              multiple
              onChange={handleFolderSelect}
              className="hidden"
            />

            {/* Scanning Animation */}
            <AnimatePresence>
              {isScanning && (
                <>
                  <motion.div
                    className="scan-line absolute inset-0"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                  />
                  <div className="absolute inset-0 cyber-grid opacity-10" />
                </>
              )}
            </AnimatePresence>

            <div className="relative z-10 flex flex-col items-center">
              <motion.div
                className="w-24 h-24 border-2 border-[#00FF88] flex items-center justify-center mb-6"
                animate={isScanning ? {
                  borderColor: ['rgba(0,255,136,0.3)', 'rgba(0,255,136,1)', 'rgba(0,255,136,0.3)'],
                  scale: [1, 1.1, 1],
                } : {}}
                transition={{ duration: 1.5, repeat: isScanning ? Infinity : 0 }}
              >
                <FileCode className="w-12 h-12 text-[#00FF88]" />
              </motion.div>

              {isScanning ? (
                <div className="text-center w-full max-w-2xl">
                  <p className="font-mono text-2xl text-[#00FF88] mb-2">{t('vuln.uploading')}</p>
                  <p className="font-mono text-[#00FF88]/60 mb-4">{t('vuln.analyzing')}</p>
                  {uploadProgress > 0 && (
                    <div className="w-64 h-2 bg-[#0A0A0A] border border-[#00FF88]/30 overflow-hidden mx-auto mb-6">
                      <motion.div
                        className="h-full bg-[#00FF88]"
                        initial={{ width: 0 }}
                        animate={{ width: `${uploadProgress}%` }}
                        style={{ boxShadow: '0 0 10px rgba(0, 255, 136, 0.5)' }}
                      />
                    </div>
                  )}
                  
                  {/* Analysis Logs */}
                  {analysisLogs.length > 0 && showLogs && (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="bg-black/50 border border-[#00FF88]/30 p-4 max-h-64 overflow-y-auto text-left"
                    >
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-mono text-sm text-[#00FF88] flex items-center gap-2">
                          <Zap className="w-4 h-4" />
                          {language === 'zh' ? 'åˆ†æè¿‡ç¨‹' : 'Analysis Process'}
                        </h3>
                        <button
                          onClick={(e) => { e.stopPropagation(); setShowLogs(!showLogs); }}
                          className="text-[#00FF88]/60 hover:text-[#00FF88] text-xs font-mono"
                        >
                          {showLogs ? 'éšè—' : 'æ˜¾ç¤º'}
                        </button>
                      </div>
                      <div className="space-y-1">
                        {analysisLogs.map((log, idx) => (
                          <motion.div
                            key={idx}
                            initial={{ opacity: 0, x: -10 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ delay: idx * 0.05 }}
                            className={`font-mono text-xs flex items-start gap-2 ${
                              log.type === 'success' ? 'text-[#00FF88]' :
                              log.type === 'warning' ? 'text-[#FF9933]' :
                              'text-[#00FF88]/70'
                            }`}
                          >
                            <span className="opacity-50 select-none">
                              {log.type === 'success' ? 'âœ“' : log.type === 'warning' ? 'âš ' : 'â€º'}
                            </span>
                            <span className="flex-1">{log.message}</span>
                          </motion.div>
                        ))}
                        <div ref={logsEndRef} />
                      </div>
                    </motion.div>
                  )}
                </div>
              ) : (
                <>
                  {/* Mode Toggle */}
                  <div className="flex items-center justify-center gap-2 mb-6">
                    <button
                      onClick={(e) => { e.stopPropagation(); setUploadMode('folder'); }}
                      className={`px-4 py-2 border-2 font-mono text-sm transition-all ${
                        uploadMode === 'folder' 
                          ? 'border-[#00FF88] bg-[#00FF88] text-[#0A0A0A]' 
                          : 'border-[#00FF88]/30 text-[#00FF88]/60 hover:border-[#00FF88]/60'
                      }`}
                    >
                      ğŸ“ {language === 'zh' ? 'é¡¹ç›®æ–‡ä»¶å¤¹' : 'Project Folder'}
                    </button>
                    <button
                      onClick={(e) => { e.stopPropagation(); setUploadMode('file'); }}
                      className={`px-4 py-2 border-2 font-mono text-sm transition-all ${
                        uploadMode === 'file' 
                          ? 'border-[#00FF88] bg-[#00FF88] text-[#0A0A0A]' 
                          : 'border-[#00FF88]/30 text-[#00FF88]/60 hover:border-[#00FF88]/60'
                      }`}
                    >
                      ğŸ“„ {language === 'zh' ? 'å•ä¸ªæ–‡ä»¶' : 'Single File'}
                    </button>
                  </div>

                  <p className="font-mono text-xl text-[#00FF88] mb-2">
                    {uploadMode === 'folder' 
                      ? (language === 'zh' ? 'æ‹–æ‹½é¡¹ç›®æ–‡ä»¶å¤¹åˆ°æ­¤å¤„ æˆ– ç‚¹å‡»é€‰æ‹©' : 'Drag & Drop Project Folder or Click to Select')
                      : (language === 'zh' ? 'æ‹–æ‹½ä»£ç æ–‡ä»¶åˆ°æ­¤å¤„ æˆ– ç‚¹å‡»ä¸Šä¼ ' : 'Drag & Drop Code File or Click to Upload')
                    }
                  </p>
                  <p className="font-mono text-[#00FF88]/50 mb-6">
                    {language === 'zh' 
                      ? 'æ”¯æŒ .js, .ts, .py, .java, .php, .cpp, .c, .go, .rb' 
                      : 'Supported: .js, .ts, .py, .java, .php, .cpp, .c, .go, .rb'}
                  </p>
                  <NeonButton onClick={(e) => { e.stopPropagation(); handleUpload(); }} icon={Upload}>
                    {uploadMode === 'folder' 
                      ? (language === 'zh' ? 'é€‰æ‹©æ–‡ä»¶å¤¹' : 'Select Folder')
                      : t('vuln.btn.upload')
                    }
                  </NeonButton>
                </>
              )}
            </div>

            {/* Error Display */}
            {error && (
              <motion.div
                className="mt-6 bg-[#FF3333]/10 border border-[#FF3333] p-4"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
              >
                <div className="flex items-start gap-3">
                  <AlertTriangle className="w-5 h-5 text-[#FF3333] flex-shrink-0 mt-0.5" />
                  <div className="flex-1">
                    <p className="font-mono text-sm text-[#FF3333]">{error}</p>
                    <p className="font-mono text-xs text-[#FF3333]/60 mt-1">
                      {language === 'zh' 
                        ? 'è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (npm run dev åœ¨ backend ç›®å½•)' 
                        : 'Make sure the backend service is running (npm run dev in backend directory)'}
                    </p>
                  </div>
                  <button
                    onClick={(e) => { e.stopPropagation(); setError(null); }}
                    className="text-[#FF3333] hover:text-[#FF5555]"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              </motion.div>
            )}
          </motion.div>
        )}

        {/* Results Section */}
        <AnimatePresence>
          {scanComplete && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="grid grid-cols-1 lg:grid-cols-2 gap-6"
            >
              {/* Left: Vulnerability List */}
              <div className="space-y-4">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-mono text-2xl text-[#00FF88] tracking-wider">{t('vuln.detected')}</h2>
                  <div className="flex items-center gap-2">
                    <NeonButton variant="success" onClick={resetScan} icon={Upload}>
                      {language === 'zh' ? 'æ‰«ææ–°æ–‡ä»¶' : 'New Scan'}
                    </NeonButton>
                  </div>
                </div>

                {/* Scan Info */}
                {scanResult && (
                  <div className="bg-[#0A0A0A] border border-[#00FF88] p-4 mb-4">
                    <div className="grid grid-cols-2 gap-4 font-mono text-sm">
                      {scanResult.type === 'folder' ? (
                        <>
                          <div>
                            <span className="text-[#00FF88]/60">{language === 'zh' ? 'æ‰«æç±»å‹' : 'Scan Type'}:</span>
                            <span className="text-[#00FF88] ml-2">ğŸ“ {language === 'zh' ? 'é¡¹ç›®æ–‡ä»¶å¤¹' : 'Project Folder'}</span>
                          </div>
                          <div>
                            <span className="text-[#00FF88]/60">{language === 'zh' ? 'æ‰«ææ–‡ä»¶æ•°' : 'Files Scanned'}:</span>
                            <span className="text-[#00FF88] ml-2">{scanResult.filesScanned} {language === 'zh' ? 'ä¸ª' : ''}</span>
                          </div>
                        </>
                      ) : (
                        <div>
                          <span className="text-[#00FF88]/60">{language === 'zh' ? 'æ–‡ä»¶å' : 'File'}:</span>
                          <span className="text-[#00FF88] ml-2">{scanResult.fileName}</span>
                        </div>
                      )}
                      <div>
                        <span className="text-[#00FF88]/60">{language === 'zh' ? 'æ‰«ææ—¶é—´' : 'Scan Time'}:</span>
                        <span className="text-[#00FF88] ml-2">{scanResult.scanTime}s</span>
                      </div>
                      <div>
                        <span className="text-[#00FF88]/60">{language === 'zh' ? 'å‘ç°æ¼æ´' : 'Vulnerabilities'}:</span>
                        <span className={`ml-2 ${
                          scanResult.totalVulnerabilities === 0 ? 'text-[#00FF88]' : 'text-[#FF3333]'
                        }`}>
                          {scanResult.totalVulnerabilities} {language === 'zh' ? 'ä¸ª' : ''}
                        </span>
                      </div>
                      <div>
                        <span className="text-[#00FF88]/60">{language === 'zh' ? 'é£é™©ç­‰çº§' : 'Risk Level'}:</span>
                        <span className={`ml-2 uppercase ${
                          scanResult.riskLevel === 'critical' ? 'text-[#FF0055]' :
                          scanResult.riskLevel === 'high' ? 'text-[#FF3333]' :
                          scanResult.riskLevel === 'medium' ? 'text-[#FF9933]' :
                          'text-[#00FF88]'
                        }`}>
                          {scanResult.riskLevel}
                        </span>
                      </div>
                    </div>

                    {/* File Results Summary for Folder Scan */}
                    {scanResult.type === 'folder' && scanResult.fileResults && scanResult.fileResults.length > 0 && (
                      <div className="mt-4 pt-4 border-t border-[#00FF88]/30">
                        <div className="font-mono text-xs text-[#00FF88]/60 mb-2">
                          {language === 'zh' ? 'æ–‡ä»¶æ‰«æè¯¦æƒ…:' : 'File Scan Details:'}
                        </div>
                        <div className="max-h-32 overflow-y-auto custom-scrollbar space-y-1">
                          {scanResult.fileResults.map((fileResult, idx) => (
                            <div key={idx} className="flex items-center justify-between font-mono text-xs">
                              <span className="text-[#00FF88]/70 truncate flex-1">{fileResult.fileName}</span>
                              <span className={`ml-2 ${
                                fileResult.vulnerabilities === 0 ? 'text-[#00FF88]' : 'text-[#FF3333]'
                              }`}>
                                {fileResult.vulnerabilities} {language === 'zh' ? 'ä¸ªæ¼æ´' : 'vulns'}
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Analysis Logs Toggle */}
                    {scanResult.analysisLogs && scanResult.analysisLogs.length > 0 && (
                      <div className="mt-4 pt-4 border-t border-[#00FF88]/30">
                        <button
                          onClick={() => setShowLogs(!showLogs)}
                          className="flex items-center justify-between w-full font-mono text-xs text-[#00FF88]/60 hover:text-[#00FF88] transition-colors"
                        >
                          <span className="flex items-center gap-2">
                            <Zap className="w-3 h-3" />
                            {language === 'zh' ? 'æŸ¥çœ‹åˆ†æè¿‡ç¨‹' : 'View Analysis Process'}
                          </span>
                          <ChevronRight className={`w-4 h-4 transition-transform ${showLogs ? 'rotate-90' : ''}`} />
                        </button>
                        
                        {showLogs && (
                          <motion.div
                            initial={{ opacity: 0, height: 0 }}
                            animate={{ opacity: 1, height: 'auto' }}
                            exit={{ opacity: 0, height: 0 }}
                            className="mt-3 bg-black/30 border border-[#00FF88]/20 p-3 max-h-48 overflow-y-auto custom-scrollbar"
                          >
                            <div className="space-y-1">
                              {scanResult.analysisLogs.map((log, idx) => (
                                <div
                                  key={idx}
                                  className={`font-mono text-xs flex items-start gap-2 ${
                                    log.type === 'success' ? 'text-[#00FF88]' :
                                    log.type === 'warning' ? 'text-[#FF9933]' :
                                    'text-[#00FF88]/70'
                                  }`}
                                >
                                  <span className="opacity-50 select-none">
                                    {log.type === 'success' ? 'âœ“' : log.type === 'warning' ? 'âš ' : 'â€º'}
                                  </span>
                                  <span className="flex-1">{log.message}</span>
                                </div>
                              ))}
                            </div>
                          </motion.div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {vulnerabilities.length === 0 ? (
                  <div className="bg-[#0A0A0A] border border-[#00FF88] p-8 text-center">
                    <CheckCircle className="w-16 h-16 text-[#00FF88] mx-auto mb-4" />
                    <h3 className="font-mono text-xl text-[#00FF88] mb-2">
                      {language === 'zh' ? 'âœ… æœªå‘ç°å®‰å…¨æ¼æ´ï¼' : 'âœ… No Vulnerabilities Found!'}
                    </h3>
                    <p className="font-mono text-sm text-[#00FF88]/60">
                      {language === 'zh' ? 'æ‚¨çš„ä»£ç çœ‹èµ·æ¥å¾ˆå®‰å…¨' : 'Your code looks secure'}
                    </p>
                  </div>
                ) : (
                  <>
                    <div className="flex items-center gap-2 px-4 py-2 bg-[#0A0A0A] border border-[#FF3333] mb-4">
                      <AlertTriangle className="w-5 h-5 text-[#FF3333]" />
                      <span className="font-mono text-[#FF3333]">{vulnerabilities.length} {t('vuln.count')}</span>
                    </div>

                    {vulnerabilities.map((vuln, index) => (
                  <motion.div
                    key={vuln.id}
                    className={`bg-[#0A0A0A] border p-4 cursor-pointer transition-all ${
                      selectedVuln?.id === vuln.id ? 'border-[#00FF88] bg-[#00FF88]/5' : 'border-[#00FF88]/30'
                    }`}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    onClick={() => setSelectedVuln(vuln)}
                    whileHover={{ 
                      y: -2,
                      boxShadow: '0 0 15px rgba(0, 255, 136, 0.4)',
                    }}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <AlertTriangle className={`w-5 h-5 ${severityColors[vuln.severity]}`} />
                          <h3 className="font-mono text-lg text-[#00FF88]">{vuln.name}</h3>
                        </div>
                        <div className="flex items-center gap-4 font-mono text-sm text-[#00FF88]/60">
                          <span>{t('vuln.location')} {vuln.location}</span>
                          <span>{t('vuln.line.label')} {vuln.line} {t('vuln.line.unit')}</span>
                        </div>
                      </div>
                      <div className={`px-3 py-1 border font-mono text-xs tracking-wider ${severityColors[vuln.severity]}`}>
                        {vuln.severity.toUpperCase()}
                      </div>
                    </div>
                  </motion.div>
                ))}
                  </>
                )}
              </div>

              {/* Right: Vulnerability Details */}
              <div className="space-y-4">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-mono text-2xl text-[#00FF88] tracking-wider">
                    {language === 'zh' ? 'æ¼æ´è¯¦æƒ…' : 'Vulnerability Details'}
                  </h2>
                </div>

                {selectedVuln ? (
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    className="space-y-4"
                  >
                    {/* Vulnerability Info */}
                    <div className="bg-[#0A0A0A] border-2 border-[#FF3333] p-6">
                      <div className="flex items-center gap-3 mb-4">
                        <AlertTriangle className={`w-6 h-6 ${severityColors[selectedVuln.severity]}`} />
                        <h3 className="font-mono text-xl text-[#00FF88]">{selectedVuln.name}</h3>
                      </div>

                      <div className="space-y-3 font-mono text-sm">
                        <div>
                          <span className="text-[#00FF88]/60">{language === 'zh' ? 'ä¸¥é‡ç¨‹åº¦' : 'Severity'}:</span>
                          <span className={`ml-2 uppercase font-bold ${severityColors[selectedVuln.severity]}`}>
                            {selectedVuln.severity}
                          </span>
                        </div>
                        <div>
                          <span className="text-[#00FF88]/60">{language === 'zh' ? 'ä½ç½®' : 'Location'}:</span>
                          <span className="text-[#00FF88] ml-2">{selectedVuln.location}</span>
                        </div>
                        <div>
                          <span className="text-[#00FF88]/60">{language === 'zh' ? 'è¡Œå·' : 'Line'}:</span>
                          <span className="text-[#00FF88] ml-2">{selectedVuln.line}</span>
                        </div>
                      </div>
                    </div>

                    {/* Description */}
                    {selectedVuln.description && (
                      <div className="bg-[#0A0A0A] border border-[#FF9933] p-4">
                        <h4 className="font-mono text-[#FF9933] mb-2 flex items-center gap-2">
                          <AlertTriangle className="w-4 h-4" />
                          {language === 'zh' ? 'é—®é¢˜æè¿°' : 'Description'}
                        </h4>
                        <p className="font-mono text-sm text-[#00FF88]/70 leading-relaxed">
                          {selectedVuln.description}
                        </p>
                      </div>
                    )}

                    {/* Code Snippet */}
                    {selectedVuln.codeSnippet && (
                      <div className="bg-[#0A0A0A] border border-[#FF3333]/50 p-4">
                        <div className="flex items-center gap-2 mb-3">
                          <div className="w-3 h-3 bg-[#FF3333]" />
                          <span className="font-mono text-[#FF3333]">
                            {language === 'zh' ? 'é—®é¢˜ä»£ç ' : 'Vulnerable Code'}
                          </span>
                        </div>
                        <pre className="bg-black/50 p-4 border border-[#FF3333]/30 font-mono text-xs overflow-x-auto">
                          <code className="text-[#00FF88]/80">{selectedVuln.codeSnippet}</code>
                        </pre>
                      </div>
                    )}

                    {/* Recommendation */}
                    {selectedVuln.recommendation && (
                      <div className="bg-[#0A0A0A] border border-[#00FF88] p-4">
                        <h4 className="font-mono text-[#00FF88] mb-2 flex items-center gap-2">
                          <CheckCircle className="w-5 h-5" />
                          {language === 'zh' ? 'ä¿®å¤å»ºè®®' : 'Recommendation'}
                        </h4>
                        <p className="font-mono text-sm text-[#00FF88]/70 leading-relaxed">
                          {selectedVuln.recommendation}
                        </p>
                      </div>
                    )}
                  </motion.div>
                ) : (
                  <div className="bg-[#0A0A0A] border border-[#00FF88]/30 p-8 text-center">
                    <FileCode className="w-16 h-16 text-[#00FF88]/30 mx-auto mb-4" />
                    <p className="font-mono text-sm text-[#00FF88]/50">
                      {language === 'zh' ? 'é€‰æ‹©ä¸€ä¸ªæ¼æ´æŸ¥çœ‹è¯¦æƒ…' : 'Select a vulnerability to view details'}
                    </p>
                  </div>
                )}
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Bottom Notice */}
        {scanComplete && scanResult && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.5 }}
            className="mt-8 text-center"
          >
            <div className="inline-block bg-[#0A0A0A] border border-[#00FF88]/30 px-6 py-3">
              <p className="font-mono text-xs text-[#00FF88]/50">
                <motion.span
                  animate={{ opacity: [0.5, 1, 0.5] }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  â–ˆ
                </motion.span>
                {' '}
                {language === 'zh' 
                  ? 'çœŸå®ä»£ç æ‰«æç³»ç»Ÿ | åŸºäº AST åˆ†æå’Œå®‰å…¨è§„åˆ™å¼•æ“' 
                  : 'Real Code Scanning System | Powered by AST Analysis & Security Rules'}
              </p>
            </div>
          </motion.div>
        )}
      </div>
    </div>
  );
}
