const acorn = require('acorn');
const walk = require('acorn-walk');
const deepseekService = require('./deepseekService');

// æ‰«ææ¨¡å¼ï¼š'ai' ä½¿ç”¨ DeepSeek APIï¼Œ'traditional' ä½¿ç”¨ AST åˆ†æ
const SCAN_MODE = process.env.SCAN_MODE || 'ai';

/**
 * ä¸»æ‰«æå‡½æ•°
 */
exports.scan = async (code, fileExtension, fileName) => {
  const analysisLogs = [];
  const addLog = (message, type = 'info') => {
    const log = { message, type, timestamp: new Date().toISOString() };
    analysisLogs.push(log);
    console.log(`${type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ”'} ${message}`);
  };

  addLog(`å¼€å§‹æ‰«ææ–‡ä»¶: ${fileName}`);
  addLog(`æ–‡ä»¶ç±»å‹: ${fileExtension}`);
  addLog(`ä»£ç è¡Œæ•°: ${code.split('\n').length}`);
  addLog(`æ‰«ææ¨¡å¼: ${SCAN_MODE === 'ai' ? 'AI æ™ºèƒ½åˆ†æ' : 'ä¼ ç»Ÿ AST åˆ†æ'}`);

  try {
    let result;
    
    // å¦‚æœä½¿ç”¨ AI æ¨¡å¼ï¼Œè°ƒç”¨ DeepSeek API
    if (SCAN_MODE === 'ai') {
      addLog('æ­£åœ¨è°ƒç”¨ DeepSeek AI è¿›è¡Œæ·±åº¦åˆ†æ...');
      result = await scanWithAI(code, fileExtension, fileName, addLog);
    } else {
      // å¦åˆ™ä½¿ç”¨ä¼ ç»Ÿ AST åˆ†æ
      result = await scanWithTraditional(code, fileExtension, fileName, addLog);
    }

    addLog(`åˆ†æå®Œæˆï¼Œå‘ç° ${result.vulnerabilities.length} ä¸ªå®‰å…¨é—®é¢˜`, 'success');
    
    return {
      ...result,
      analysisLogs
    };

  } catch (error) {
    addLog(`æ‰«æå¤±è´¥: ${error.message}`, 'warning');

    // å¦‚æœ AI æ¨¡å¼å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼
    if (SCAN_MODE === 'ai') {
      addLog('AI æ‰«æå¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ‰«ææ¨¡å¼', 'warning');
      const result = await scanWithTraditional(code, fileExtension, fileName, addLog);
      return {
        ...result,
        analysisLogs
      };
    }

    throw error;
  }
};

/**
 * ä½¿ç”¨ AI (DeepSeek) æ‰«æ
 */
async function scanWithAI(code, fileExtension, fileName, addLog) {
  // ç¡®å®šç¼–ç¨‹è¯­è¨€
  const languageMap = {
    '.js': 'JavaScript',
    '.jsx': 'JavaScript (React)',
    '.ts': 'TypeScript',
    '.tsx': 'TypeScript (React)',
    '.py': 'Python',
    '.php': 'PHP',
    '.java': 'Java',
    '.cpp': 'C++',
    '.c': 'C',
    '.go': 'Go',
    '.rb': 'Ruby'
  };

  const language = languageMap[fileExtension] || 'Unknown';
  addLog(`è¯†åˆ«è¯­è¨€: ${language}`);

  // è°ƒç”¨ DeepSeek API
  addLog('æ­£åœ¨æ„å»ºå®‰å…¨åˆ†ææç¤ºè¯...');
  const result = await deepseekService.analyzeCodeVulnerabilities(code, language, fileName);
  addLog('AI åˆ†æå®Œæˆ');

  return {
    ...result,
    status: 'completed',
    scanMethod: 'AI (DeepSeek-R1)'
  };
}

/**
 * ä½¿ç”¨ä¼ ç»Ÿ AST/æ­£åˆ™åˆ†æ
 */
async function scanWithTraditional(code, fileExtension, fileName, addLog) {
  const vulnerabilities = [];
  let riskLevel = 'low';

  addLog('å¼€å§‹ AST è¯­æ³•æ ‘è§£æ...');
  
  // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©æ‰«æå™¨
  switch (fileExtension) {
    case '.js':
    case '.jsx':
    case '.ts':
    case '.tsx':
      addLog('ä½¿ç”¨ JavaScript/TypeScript å®‰å…¨è§„åˆ™å¼•æ“');
      addLog('æ£€æµ‹ XSS è·¨ç«™è„šæœ¬æ”»å‡»...');
      addLog('æ£€æµ‹ä»£ç æ³¨å…¥é£é™©...');
      addLog('æ£€æµ‹ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ...');
      vulnerabilities.push(...scanJavaScript(code, fileName));
      break;
    case '.py':
      addLog('ä½¿ç”¨ Python å®‰å…¨è§„åˆ™å¼•æ“');
      addLog('æ£€æµ‹ SQL æ³¨å…¥é£é™©...');
      addLog('æ£€æµ‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–...');
      vulnerabilities.push(...scanPython(code, fileName));
      break;
    case '.php':
      addLog('ä½¿ç”¨ PHP å®‰å…¨è§„åˆ™å¼•æ“');
      addLog('æ£€æµ‹ SQL æ³¨å…¥æ¼æ´...');
      addLog('æ£€æµ‹æ–‡ä»¶åŒ…å«æ¼æ´...');
      addLog('æ£€æµ‹å‘½ä»¤æ³¨å…¥æ¼æ´...');
      vulnerabilities.push(...scanPHP(code, fileName));
      break;
    case '.java':
      addLog('ä½¿ç”¨ Java å®‰å…¨è§„åˆ™å¼•æ“');
      addLog('æ£€æµ‹ XXE å¤–éƒ¨å®ä½“æ³¨å…¥...');
      addLog('æ£€æµ‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–...');
      vulnerabilities.push(...scanJava(code, fileName));
      break;
    default:
      addLog('ä½¿ç”¨é€šç”¨å®‰å…¨è§„åˆ™å¼•æ“');
      vulnerabilities.push(...scanGeneric(code, fileName));
  }

  addLog('æ£€æµ‹ç¡¬ç¼–ç å¯†é’¥å’Œæ•æ„Ÿä¿¡æ¯...');
  addLog('æ£€æµ‹å¼±åŠ å¯†ç®—æ³•ä½¿ç”¨...');
  addLog('æ£€æµ‹ä¸å®‰å…¨çš„ç½‘ç»œè¿æ¥...');
  
  // è®¡ç®—é£é™©ç­‰çº§
  const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
  const highCount = vulnerabilities.filter(v => v.severity === 'high').length;

  if (criticalCount > 0) {
    riskLevel = 'critical';
    addLog(`å‘ç° ${criticalCount} ä¸ªä¸¥é‡æ¼æ´ï¼`, 'warning');
  } else if (highCount > 0) {
    riskLevel = 'high';
    addLog(`å‘ç° ${highCount} ä¸ªé«˜å±æ¼æ´`, 'warning');
  } else if (vulnerabilities.length > 0) {
    riskLevel = 'medium';
    addLog(`å‘ç° ${vulnerabilities.length} ä¸ªä¸­ä½å±æ¼æ´`);
  } else {
    addLog('æœªå‘ç°å®‰å…¨æ¼æ´', 'success');
  }

  addLog('æ­£åœ¨ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š...');

  return {
    vulnerabilities,
    totalVulnerabilities: vulnerabilities.length,
    riskLevel,
    status: 'completed',
    scanMethod: 'Traditional AST'
  };
}

/**
 * JavaScript/TypeScript æ‰«æå™¨
 */
function scanJavaScript(code, fileName) {
  const vulnerabilities = [];
  const lines = code.split('\n');

  try {
    // ä½¿ç”¨ acorn è§£æ AST
    const ast = acorn.parse(code, {
      ecmaVersion: 'latest',
      sourceType: 'module',
      locations: true
    });

    // éå† AST æŸ¥æ‰¾æ¼æ´
    walk.simple(ast, {
      CallExpression(node) {
        // æ£€æµ‹ eval() ä½¿ç”¨
        if (node.callee.name === 'eval') {
          vulnerabilities.push({
            id: `vuln-${vulnerabilities.length + 1}`,
            name: 'Eval å‡½æ•°ä½¿ç”¨',
            severity: 'high',
            location: fileName,
            line: node.loc.start.line,
            description: 'ä½¿ç”¨ eval() å‡½æ•°å¯èƒ½å¯¼è‡´ä»£ç æ³¨å…¥æ”»å‡»',
            recommendation: 'é¿å…ä½¿ç”¨ eval()ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆå¦‚ JSON.parse() æˆ– Function constructor',
            codeSnippet: lines[node.loc.start.line - 1]?.trim()
          });
        }

        // æ£€æµ‹ innerHTML ä½¿ç”¨
        if (node.callee.property && node.callee.property.name === 'innerHTML') {
          vulnerabilities.push({
            id: `vuln-${vulnerabilities.length + 1}`,
            name: 'XSS - innerHTML ä½¿ç”¨',
            severity: 'high',
            location: fileName,
            line: node.loc.start.line,
            description: 'ç›´æ¥è®¾ç½® innerHTML å¯èƒ½å¯¼è‡´è·¨ç«™è„šæœ¬æ”»å‡» (XSS)',
            recommendation: 'ä½¿ç”¨ textContent æˆ–ç»è¿‡ sanitize çš„å†…å®¹',
            codeSnippet: lines[node.loc.start.line - 1]?.trim()
          });
        }

        // æ£€æµ‹ dangerouslySetInnerHTML (React)
        if (node.arguments && node.arguments.some(arg => 
          arg.type === 'Identifier' && arg.name === 'dangerouslySetInnerHTML'
        )) {
          vulnerabilities.push({
            id: `vuln-${vulnerabilities.length + 1}`,
            name: 'XSS - dangerouslySetInnerHTML',
            severity: 'high',
            location: fileName,
            line: node.loc.start.line,
            description: 'ä½¿ç”¨ dangerouslySetInnerHTML å¯èƒ½å¯¼è‡´ XSS æ”»å‡»',
            recommendation: 'ç¡®ä¿å†…å®¹ç»è¿‡ sanitize å¤„ç†ï¼Œæˆ–ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ¸²æŸ“å†…å®¹',
            codeSnippet: lines[node.loc.start.line - 1]?.trim()
          });
        }
      },

      // æ£€æµ‹ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ
      MemberExpression(node) {
        if (node.object.name === 'Math' && node.property.name === 'random' &&
            code.includes('password') || code.includes('token') || code.includes('secret')) {
          vulnerabilities.push({
            id: `vuln-${vulnerabilities.length + 1}`,
            name: 'ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ',
            severity: 'medium',
            location: fileName,
            line: node.loc.start.line,
            description: 'Math.random() ä¸é€‚åˆç”¨äºå®‰å…¨ç›¸å…³çš„éšæœºæ•°ç”Ÿæˆ',
            recommendation: 'ä½¿ç”¨ crypto.randomBytes() æˆ– crypto.getRandomValues()',
            codeSnippet: lines[node.loc.start.line - 1]?.trim()
          });
        }
      }
    });

  } catch (error) {
    console.log('AST è§£æå¤±è´¥ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰«æ:', error.message);
  }

  // æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹
  vulnerabilities.push(...scanWithRegex(code, lines, fileName));

  return vulnerabilities;
}

/**
 * Python æ‰«æå™¨
 */
function scanPython(code, fileName) {
  const vulnerabilities = [];
  const lines = code.split('\n');

  lines.forEach((line, index) => {
    const lineNum = index + 1;

    // SQL æ³¨å…¥æ£€æµ‹
    if (/execute\s*\([^)]*[+%]/.test(line) || /cursor\.execute\s*\([^)]*[+%]/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'SQL æ³¨å…¥é£é™©',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»º SQL æŸ¥è¯¢å¯èƒ½å¯¼è‡´ SQL æ³¨å…¥',
        recommendation: 'ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ– ORM',
        codeSnippet: line.trim()
      });
    }

    // eval/exec ä½¿ç”¨
    if (/\beval\s*\(|\bexec\s*\(/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ä»£ç æ³¨å…¥é£é™© - eval/exec',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨ eval() æˆ– exec() å¯èƒ½å¯¼è‡´ä»£ç æ³¨å…¥',
        recommendation: 'é¿å…ä½¿ç”¨ eval/execï¼Œå¯»æ‰¾æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ',
        codeSnippet: line.trim()
      });
    }

    // pickle ä¸å®‰å…¨ä½¿ç”¨
    if (/pickle\.loads?\s*\(/.test(line) && !line.includes('#') && !line.includes('trusted')) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ä¸å®‰å…¨çš„ååºåˆ—åŒ–',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'pickle.loads() å¯èƒ½æ‰§è¡Œæ¶æ„ä»£ç ',
        recommendation: 'åªå¯¹å¯ä¿¡æ•°æ®ä½¿ç”¨ pickleï¼Œæˆ–ä½¿ç”¨ JSON ç­‰æ›´å®‰å…¨çš„æ ¼å¼',
        codeSnippet: line.trim()
      });
    }

    // ç¡¬ç¼–ç å¯†ç 
    if (/password\s*=\s*["'][^"']+["']|secret\s*=\s*["'][^"']+["']/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ç¡¬ç¼–ç å‡­è¯',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ä»£ç ä¸­åŒ…å«ç¡¬ç¼–ç çš„å¯†ç æˆ–å¯†é’¥',
        recommendation: 'ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ç®¡ç†æ•æ„Ÿä¿¡æ¯',
        codeSnippet: line.trim()
      });
    }
  });

  return vulnerabilities;
}

/**
 * PHP æ‰«æå™¨
 */
function scanPHP(code, fileName) {
  const vulnerabilities = [];
  const lines = code.split('\n');

  lines.forEach((line, index) => {
    const lineNum = index + 1;

    // SQL æ³¨å…¥
    if (/mysql_query\s*\(.*\$_(?:GET|POST|REQUEST)/.test(line) || 
        /mysqli_query\s*\(.*\$_(?:GET|POST|REQUEST)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'SQL æ³¨å…¥æ¼æ´',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ç›´æ¥åœ¨ SQL æŸ¥è¯¢ä¸­ä½¿ç”¨ç”¨æˆ·è¾“å…¥',
        recommendation: 'ä½¿ç”¨é¢„å¤„ç†è¯­å¥ (prepared statements)',
        codeSnippet: line.trim()
      });
    }

    // XSS
    if (/echo\s+\$_(?:GET|POST|REQUEST)|print\s+\$_(?:GET|POST|REQUEST)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'XSS è·¨ç«™è„šæœ¬æ”»å‡»',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'æœªè¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥ç›´æ¥è¾“å‡º',
        recommendation: 'ä½¿ç”¨ htmlspecialchars() æˆ– htmlentities() è½¬ä¹‰è¾“å‡º',
        codeSnippet: line.trim()
      });
    }

    // æ–‡ä»¶åŒ…å«æ¼æ´
    if (/(?:include|require)(?:_once)?\s*\(.*\$_(?:GET|POST|REQUEST)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'æ–‡ä»¶åŒ…å«æ¼æ´',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨ç”¨æˆ·è¾“å…¥è¿›è¡Œæ–‡ä»¶åŒ…å«',
        recommendation: 'ä½¿ç”¨ç™½åå•éªŒè¯æ–‡ä»¶è·¯å¾„',
        codeSnippet: line.trim()
      });
    }

    // å‘½ä»¤æ³¨å…¥
    if (/(?:exec|system|passthru|shell_exec)\s*\(.*\$_(?:GET|POST|REQUEST)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'å‘½ä»¤æ³¨å…¥æ¼æ´',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨ç”¨æˆ·è¾“å…¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤',
        recommendation: 'é¿å…æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæˆ–ä½¿ç”¨ escapeshellarg() è½¬ä¹‰å‚æ•°',
        codeSnippet: line.trim()
      });
    }
  });

  return vulnerabilities;
}

/**
 * Java æ‰«æå™¨
 */
function scanJava(code, fileName) {
  const vulnerabilities = [];
  const lines = code.split('\n');

  lines.forEach((line, index) => {
    const lineNum = index + 1;

    // SQL æ³¨å…¥
    if (/Statement.*execute.*\+/.test(line) || /createStatement.*execute/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'SQL æ³¨å…¥é£é™©',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»º SQL æŸ¥è¯¢',
        recommendation: 'ä½¿ç”¨ PreparedStatement',
        codeSnippet: line.trim()
      });
    }

    // XXE æ¼æ´
    if (/DocumentBuilderFactory/.test(line) && !code.includes('setFeature')) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'XXE (XML å¤–éƒ¨å®ä½“æ³¨å…¥)',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'XML è§£æå™¨æœªç¦ç”¨å¤–éƒ¨å®ä½“',
        recommendation: 'ç¦ç”¨ DTD å’Œå¤–éƒ¨å®ä½“å¤„ç†',
        codeSnippet: line.trim()
      });
    }

    // ä¸å®‰å…¨çš„ååºåˆ—åŒ–
    if (/ObjectInputStream.*readObject/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ä¸å®‰å…¨çš„ååºåˆ—åŒ–',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®å¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œ',
        recommendation: 'éªŒè¯åºåˆ—åŒ–æ•°æ®æ¥æºï¼Œä½¿ç”¨ç™½åå•',
        codeSnippet: line.trim()
      });
    }
  });

  return vulnerabilities;
}

/**
 * é€šç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰«æ
 */
function scanWithRegex(code, lines, fileName) {
  const vulnerabilities = [];

  lines.forEach((line, index) => {
    const lineNum = index + 1;

    // ç¡¬ç¼–ç å¯†ç /å¯†é’¥
    if (/(?:password|passwd|pwd|secret|api[_-]?key|token)\s*[:=]\s*["'][^"']{8,}["']/.test(line.toLowerCase())) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯',
        severity: 'critical',
        location: fileName,
        line: lineNum,
        description: 'ä»£ç ä¸­åŒ…å«ç¡¬ç¼–ç çš„å¯†ç æˆ– API å¯†é’¥',
        recommendation: 'ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡',
        codeSnippet: line.trim()
      });
    }

    // HTTP è€Œé HTTPS
    if (/['"]http:\/\/(?!localhost|127\.0\.0\.1)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ä¸å®‰å…¨çš„ HTTP è¿æ¥',
        severity: 'medium',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨ HTTP è€Œé HTTPS ä¼ è¾“æ•°æ®',
        recommendation: 'ä½¿ç”¨ HTTPS åŠ å¯†ä¼ è¾“',
        codeSnippet: line.trim()
      });
    }

    // SQL å…³é”®å­—æ‹¼æ¥
    if (/(SELECT|INSERT|UPDATE|DELETE).*\+.*(?:input|data|param|request)/.test(line)) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'SQL æ³¨å…¥é£é™©',
        severity: 'high',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»º SQL æŸ¥è¯¢',
        recommendation: 'ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ– ORM',
        codeSnippet: line.trim()
      });
    }

    // å¼±åŠ å¯†ç®—æ³•
    if (/\b(MD5|SHA1|DES|RC4)\b/.test(line) && /crypt|hash|encrypt/.test(line.toLowerCase())) {
      vulnerabilities.push({
        id: `vuln-${vulnerabilities.length + 1}`,
        name: 'ä½¿ç”¨å¼±åŠ å¯†ç®—æ³•',
        severity: 'medium',
        location: fileName,
        line: lineNum,
        description: 'ä½¿ç”¨äº†ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•',
        recommendation: 'ä½¿ç”¨ SHA-256ã€bcrypt æˆ– AES-256',
        codeSnippet: line.trim()
      });
    }
  });

  return vulnerabilities;
}

/**
 * é€šç”¨æ‰«æå™¨ï¼ˆä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼‰
 */
function scanGeneric(code, fileName) {
  return scanWithRegex(code, code.split('\n'), fileName);
}

